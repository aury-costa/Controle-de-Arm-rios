<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arm√°rios ‚Ä¢ Colaboradores</title>
  <link rel="stylesheet" href="styles.css" />

  <script>
    (function(){
      try{
        var p = new URLSearchParams(location.search);
        if(p.get('claim') === '1') document.documentElement.classList.add('claim-mode');
      }catch(e){}
    })();
  </script>

</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">üîê</div>
      <div>
        <div class="title">Controle de Arm√°rios</div>
        <div class="subtitle">Mapeie colaboradores ‚Üî arm√°rio e controle disponibilidade</div>
      </div>
        <div class="conn" id="connStatus">Conectando‚Ä¶</div>
        <button class="btn btn-ghost small" id="btnAdminLogout" title="Sair">Sair üîí</button>
      </div>
    </div>

    <div class="stats">
      <div class="pill">
        <div class="pill-label">Total</div>
        <div class="pill-value" id="totalLockers">300</div>
      </div>
      <div class="pill">
        <div class="pill-label">Ocupados</div>
        <div class="pill-value" id="usedLockers">0</div>
      </div>
      <div class="pill pill-ok">
        <div class="pill-label">Dispon√≠veis</div>
        <div class="pill-value" id="freeLockers">300</div>
      </div>

      <div class="pill pill-warn" id="zeroKeysPill" title="Arm√°rios onde n√£o existe chave reserva (dispon√≠vel = 0)">
        <div class="pill-label">Sem reserva</div>
        <div class="pill-value" id="zeroKeysCount">0</div>
      </div>
    </div>
  </header>

  <main class="container">
    <nav class="tabs">
      <button class="tab active" data-tab="colabs">Colaboradores üë•</button>
      <button class="tab" data-tab="lockers">Arm√°rios üß∞</button>
      <button class="tab" data-tab="import">Importar/Exportar üì¶</button>
      <button class="tab" data-tab="config">Config ‚öôÔ∏è</button>
      <button class="tab" data-tab="history">Hist√≥rico üìú</button>
    </nav>

    
    <section class="claim-only" id="claimOnly">
      <div class="claim-card">
        <div class="claim-title">üîê Confirmar arm√°rio</div>
        <div class="muted small" id="claimSub">Autoatendimento via QR do arm√°rio</div>

        <div class="form-grid" style="margin-top:12px">
          <label>
            <span>Arm√°rio</span>
            <input id="claimOnlyLocker" type="number" readonly />
          </label>

          <label>
            <span>Matr√≠cula</span>
            <input id="claimOnlyCadastro" type="text" inputmode="numeric" placeholder="Ex.: 26335" />
          </label>

          <label style="grid-column: 1 / -1">
            <span>Nome</span>
            <input id="claimOnlyNome" type="text" readonly placeholder="Digite a matr√≠cula" />
          </label>

          <label style="grid-column: 1 / -1; display:flex; gap:10px; align-items:center">
            <input id="claimOnlyAgree" type="checkbox" />
            <span class="small">Est√° correto? Confirmo que este arm√°rio √© meu.</span>
          </label>
        </div>

        <div class="row" style="gap:10px; margin-top:14px">
          <button class="btn" id="claimOnlyConfirm" disabled>Confirmar</button>
        </div>

        <div class="muted small" id="claimOnlyMsg" style="margin-top:10px"></div>
      </div>
    </section>


    
    <section class="admin-only" id="adminGate">
      <div class="admin-card">
        <div class="admin-title">üîí Acesso restrito (DP)</div>
        <div class="muted small">Digite o PIN de administrador para acessar o sistema completo.</div>

        <div class="form-grid" style="margin-top:12px">
          <label style="grid-column: 1 / -1">
            <span>PIN Admin</span>
            <input id="adminPinInput" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </label>
        </div>

        <div class="row" style="gap:10px; margin-top:14px">
          <button class="btn" id="btnAdminEnter">Entrar</button>
        </div>

        <div class="muted small" id="adminGateMsg" style="margin-top:10px"></div>
      </div>
    </section>

<section class="panel active" id="tab-colabs">
      <div class="toolbar">
        <div class="search">
          <input id="searchInput" type="search" placeholder="Buscar por matr√≠cula, nome, cargo..." />
          <span class="hint">Dica: clique no arm√°rio para editar</span>
        </div>

        <div class="actions">
          <button class="btn" id="btnAdd">+ Novo colaborador</button>
          <button class="btn btn-ghost" id="btnClearFilters">Limpar busca</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="grid">
          <thead>
            <tr>
              <th>Matr√≠cula</th>
              <th>Nome</th>
              <th>Admiss√£o</th>
              <th>Cargo</th>
              <th>Arm√°rio</th>
              <th>Posi√ß√£o</th>
              <th>Chave entregue em</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="footer-note">
        <span class="muted">Os dados ficam salvos no Firebase (tempo real). Use Exportar para backup.</span>
      </div>
    </section>

    <section class="panel" id="tab-lockers">
      <div class="toolbar">
        <div class="search">
          <input id="lockerFilter" type="search" placeholder="Filtrar (ex: 42, 1-50, 2xx)..." />
          <span class="hint">Use o filtro ao lado para ver todos / livres / ocupados</span>
        </div>
        <div class="actions">
          
          <select id="lockerStatus" class="select">
            <option value="all">Todos</option>
            <option value="free">Livres</option>
            <option value="used">Ocupados</option>
          </select>
          <button class="btn btn-ghost" id="btnCopyFree">Copiar lista</button>
        </div>
      </div>

      <div class="lockers">
        <div class="lockers-head">
          <div class="lockers-title">Arm√°rios dispon√≠veis</div>
          <div class="lockers-sub" id="freeSummary"></div>
        </div>
        
        <div class="card locker-pos-card">
          <h3>Posi√ß√£o (Cima/Baixo)</h3>
          <p class="muted small">Defina a posi√ß√£o de um arm√°rio pelo n√∫mero. Se n√£o definir, o app usa a regra padr√£o da aba Config.</p>
          <div class="row">
            <input type="number" id="posNumber" min="1" placeholder="N¬∫ do arm√°rio" />
            <select id="posValue">
              <option value="BAIXO">BAIXO</option>
              <option value="CIMA">CIMA</option>
            </select>
            <button class="btn" id="btnSavePos">Salvar posi√ß√£o</button>
          </div>
        
        <div class="card locker-keys-card">
          <h3>Chaves por arm√°rio (c√≥pias)</h3>
          <p class="muted small">Defina quantas c√≥pias de chave existem para um arm√°rio. Padr√£o: 1. O app calcula automaticamente quantas est√£o dispon√≠veis.</p>
          <div class="row">
            <input type="number" id="keyNumber" min="1" placeholder="N¬∫ do arm√°rio" />
            <input type="number" id="keyTotal" min="1" max="99" placeholder="Total de chaves" />
            <button class="btn" id="btnSaveKeys">Salvar chaves</button>
            <button class="btn btn-ghost" id="btnAddCopy">+1 c√≥pia</button>
          </div>
        </div>

</div>
<div class="row wrap" style="gap:10px; margin-top:10px">
            <label class="inline" style="min-width:260px">
              <span class="muted small">URL p√∫blica (opcional)</span>
              <input id="qrBaseUrl" type="url" placeholder="https://seusite.com/index.html" style="width:260px" />
            </label>

            <label class="inline">
              <span class="muted small">De</span>
              <input id="qrFrom" type="number" min="1" placeholder="1" style="width:90px" />
            </label>
            <label class="inline">
              <span class="muted small">At√©</span>
              <input id="qrTo" type="number" min="1" placeholder="50" style="width:90px" />
            </label>
            <button class="btn" id="btnGenQR">Gerar QRs</button>
            <button class="btn btn-ghost" id="btnPrintQR">Imprimir</button>
            <div class="muted small" id="qrHint" style="margin-left:auto"></div>
          </div>

          <div id="qrGrid" class="qr-grid" style="margin-top:12px"></div>
        </div>

        <div id="freeGrid" class="free-grid"></div>
      </div>
    


        
        <div class="card qr-card">
          <div class="qr-head">
            <h3>üì∑ QR Codes dos arm√°rios (autoatendimento)</h3>
            <p class="muted small">Cole o QR no arm√°rio. Ao escanear, o colaborador confirma a matr√≠cula e associa o arm√°rio ao seu cadastro. N√£o altera a estrutura do Firebase.</p>
          </div>

          
</section>

    <section class="panel" id="tab-import">
      <div class="cards">
        <div class="card">
          <h3>Importar XML</h3>
          <p class="muted">
            Se voc√™ tiver um XML com colaboradores (Cadastro, Nome, Admiss√£o, Cargo, Numero do armario),
            d√° pra importar aqui. Se a matr√≠cula j√° existir, o app atualiza os dados.
          </p>
          <input type="file" id="xmlFile" accept=".xml,text/xml,application/xml" />
          <div class="row">
            <button class="btn" id="btnImportXml">Importar XML</button>
          </div>
          <p class="muted small">Observa√ß√£o: a importa√ß√£o n√£o apaga seus dados atuais; apenas mescla.</p>
        </div>

        <div class="card">
          <h3>Exportar</h3>
          <p class="muted">Fa√ßa backup dos dados atuais em JSON (recomendado) ou exporte XML.</p>
          <div class="row">
            <button class="btn" id="btnExportJson">Baixar JSON</button>
            <button class="btn btn-ghost" id="btnExportXml">Baixar XML</button>
          </div>
        </div>

        <div class="card danger">
          <h3>Reset</h3>
          <p class="muted">Apaga os dados salvos no navegador e volta para a base inicial (do seu arquivo).</p>
          <div class="row">
            <button class="btn btn-danger" id="btnReset">Resetar</button>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="tab-config">
      <div class="cards">
        
        <div class="card">
          <h3>Regra padr√£o Cima/Baixo</h3>
          <p class="muted">Se n√£o houver configura√ß√£o por n√∫mero, o app usa esta regra:</p>
          <p class="muted small"><b>1 at√© X = (configur√°vel)</b> ‚Ä¢ <b>X+1 at√© Total = o oposto</b></p>
          <div class="row">
            <input type="number" id="splitInput" min="0" />
            <select id="padraoAteInput" class="select">
              <option value="BAIXO">At√© X = BAIXO</option>
              <option value="CIMA">At√© X = CIMA</option>
            </select>
            <button class="btn" id="btnSaveSplit">Salvar</button>
          </div>
        </div>

<div class="card">
          <h3>Total de arm√°rios</h3>
          <p class="muted">Por padr√£o est√° em 300. Se mudar, a lista de dispon√≠veis e valida√ß√µes seguem o novo total.</p>
          <div class="row">
            <input type="number" id="totalInput" min="1" max="5000" />
            <button class="btn" id="btnSaveTotal">Salvar</button>
          </div>
        </div>

        <div class="card">
          <h3>Importar backup (JSON)</h3>
          <p class="muted">Restaure um backup exportado anteriormente.</p>
          <input type="file" id="jsonFile" accept=".json,application/json" />
          <div class="row">
            <button class="btn" id="btnImportJson">Importar JSON</button>
          </div>
        </div>
      </div>
    </section>


    <section class="panel" id="tab-history">
      <div class="cards">

        <div class="card">
          <h3>üóùÔ∏è Controle r√°pido de chaves</h3>
          <p class="muted small">Registre c√≥pias, perdas e entregas/devolu√ß√µes <b>sem mexer na estrutura do Firebase</b> (apenas adiciona eventos em <b>/historicoChaves</b> e, quando necess√°rio, ajusta <b>/lockerKeys</b> e/ou <b>/employees</b>).</p>
          <div class="form-grid" style="margin-top:10px">
            <label>
              <span>Arm√°rio</span>
              <input id="keyEvtLocker" type="number" min="1" placeholder="N¬∫ do arm√°rio" />
            </label>

            <label>
              <span>A√ß√£o</span>
              <select id="keyEvtType" class="select">
                <option value="ENTREGOU">Entregou chave</option>
                <option value="DEVOLVEU">Devolveu chave</option>
                <option value="PERDEU">Perdeu chave</option>
                <option value="COPIA_FEITA">Fiz c√≥pia (+1)</option>
              </select>
            </label>

            <label>
              <span>Colaborador</span>
              <select id="keyEvtEmp" class="select">
                <option value="">(selecione)</option>
              </select>
            </label>

            <label>
              <span>Data</span>
              <input id="keyEvtDate" type="date" />
            </label>
          </div>

          <label style="display:block; margin-top:10px">
            <span>Observa√ß√£o (opcional)</span>
            <input id="keyEvtObs" placeholder="Ex.: entreguei 2¬™ via, chave quebrada, etc." />
          </label>

          <div class="row" style="margin-top:12px">
            <button class="btn" id="btnKeyEvtSave">Registrar evento</button>
            <button class="btn btn-ghost" id="btnKeyEvtClear">Limpar</button>
          </div>
        </div>

        <div class="card">
          <h3>üìú Hist√≥rico de chaves</h3>
          <p class="muted small">√öltimos 200 registros (tempo real). Voc√™ pode abrir direto em <b>/historicoChaves</b>.</p>
          <div class="row">
            <input id="histFilter" type="search" placeholder="Filtrar por arm√°rio, matr√≠cula, nome..." />
            <button class="btn btn-ghost" id="btnClearHist">Limpar filtro</button>
          </div>
          <div class="table-wrap" style="margin-top:12px">
            <table class="grid" style="min-width: 980px">
              <thead>
                <tr>
                  <th>Quando</th>
                  <th>Tipo</th>
                  <th>Arm√°rio</th>
                  <th>Matr√≠cula</th>
                  <th>Nome</th>
                  <th>Obs</th>
                </tr>
              </thead>
              <tbody id="histBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card danger">
          <h3>üìä Relat√≥rio ‚Ä¢ Arm√°rios em risco (1 chave)</h3>
          <p class="muted small">Lista dos arm√°rios que possuem <b>apenas 1 c√≥pia</b>. Recomenda-se fazer c√≥pia extra.</p>
          <div id="riskSummary" class="muted small" style="margin-bottom:8px"></div>
          <div id="riskGrid" class="free-grid"></div>
        </div>

        <div class="card danger">
          <h3>üîî Alerta autom√°tico ‚Ä¢ 0 chaves dispon√≠veis</h3>
          <p class="muted small">Arm√°rios onde <b>todas as c√≥pias</b> est√£o em uso (dispon√≠vel = 0).</p>
          <div id="zeroKeysSummary" class="muted small" style="margin-bottom:8px"></div>
          <div id="zeroKeysGrid" class="free-grid"></div>
        </div>
      </div>
    </section>

</section>

  </main>

  <!-- Modal -->
  <dialog id="modal">
    <form method="dialog" class="modal">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Novo colaborador</div>
        <button class="icon-btn" value="cancel" aria-label="Fechar">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-grid">
          <label>
            <span>Matr√≠cula (Cadastro)</span>
            <input id="fCadastro" required />
          </label>

          <label>
            <span>Nome</span>
            <input id="fNome" required />
          </label>

          <label>
            <span>Admiss√£o</span>
            <input id="fAdmissao" type="date" />
          </label>

          <label>
            <span>Cargo</span>
            <input id="fCargo" />
          </label>

          <label>
            <span>Arm√°rio</span>
            <select id="fArmario">
              <option value="">(sem arm√°rio)</option>
            </select>
          </label>

          <label>
            <span>Chave entregue em</span>
            <input id="fChave" type="date" />
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" value="cancel">Cancelar</button>
        <button class="btn" id="btnSave" value="default">Salvar</button>
      </div>
    </form>
  </dialog>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script type="module" src="app.js"></script>

  <dialog id="claimModal" class="modal">
    <form method="dialog" class="modal-card" id="claimForm">
      <div class="modal-head">
        <div>
          <div class="modal-title">Confirmar arm√°rio</div>
          <div class="muted small">Escaneado via QR do arm√°rio</div>
        </div>
        <button class="icon-btn" value="cancel" aria-label="Fechar">‚úï</button>
      </div>

      <div class="form-grid" style="margin-top:10px">
        <label>
          <span>Arm√°rio</span>
          <input id="claimLocker" type="number" readonly />
        </label>

        <label>
          <span>Matr√≠cula</span>
          <input id="claimCadastro" type="text" inputmode="numeric" placeholder="Ex.: 26335" />
        </label>

        <label style="grid-column: 1 / -1">
          <span>Nome (encontrado)</span>
          <input id="claimNome" type="text" readonly placeholder="Digite a matr√≠cula para carregar" />
        </label>

        <label style="grid-column: 1 / -1; display:flex; gap:10px; align-items:center">
          <input id="claimAgree" type="checkbox" />
          <span class="small">Confirmo que este arm√°rio √© meu.</span>
        </label>
      </div>

      <div class="modal-actions" style="margin-top:12px">
        <button class="btn btn-ghost" value="cancel" type="button" id="claimCancel">Cancelar</button>
        <button class="btn" value="default" type="submit" id="claimConfirm" disabled>Confirmar</button>
      </div>
    </form>
  </dialog>

</body>
</html>
